<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sovran Wealth Fund (SWF)</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #f8f9fa;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .api-status {
      display: flex;
      align-items: center;
      font-size: 14px;
      padding: 6px 12px;
      border-radius: 4px;
    }
    .api-status.connected {
      background-color: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }
    .api-status.disconnected {
      background-color: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .connected .status-indicator {
      background-color: #10b981;
    }
    .disconnected .status-indicator {
      background-color: #ef4444;
    }
    .card {
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    .dashboard-section {
      margin-bottom: 40px;
    }
    h1, h2, h3 {
      margin-top: 0;
      color: #f8f9fa;
    }
    h1 {
      font-size: 2.2rem;
    }
    h2 {
      font-size: 1.5rem;
      margin-bottom: 20px;
    }
    .data-value {
      font-size: 1.8rem;
      font-weight: bold;
      margin: 10px 0;
      color: #60a5fa;
    }
    .data-label {
      color: #9ca3af;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .data-secondary {
      color: #d1d5db;
      font-size: 0.9rem;
    }
    .role-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
    }
    .role-item:last-child {
      border-bottom: none;
    }
    .button {
      display: inline-block;
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .button:hover {
      background-color: #4338ca;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .badge-primary {
      background-color: rgba(79, 70, 229, 0.2);
      color: #818cf8;
    }
    .badge-success {
      background-color: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }
    .actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Sovran Wealth Fund</h1>
      <div id="apiStatus" class="api-status disconnected">
        <span class="status-indicator"></span>
        Connecting...
      </div>
    </header>

    <div class="dashboard-section">
      <h2>Token Overview</h2>
      <div class="cards-grid">
        <div class="card">
          <div class="data-label">Token Contract</div>
          <div class="data-value" id="tokenAddress">0x15AD65Fb62CD9147Aa4443dA89828A693228b5F7</div>
          <div class="data-secondary">Polygon Mainnet</div>
        </div>
        <div class="card">
          <div class="data-label">Total Supply</div>
          <div class="data-value" id="tokenSupply">500,000</div>
          <div class="data-secondary">SWF Tokens</div>
        </div>
        <div class="card">
          <div class="data-label">Current APR</div>
          <div class="data-value" id="currentApr">15%</div>
          <div class="data-secondary">Dynamic based on vault deposits</div>
        </div>
      </div>
    </div>

    <div class="dashboard-section">
      <h2>Latest Transaction</h2>
      <div class="card" id="latestTransaction">
        <div id="txLoading">
          <span class="loading"></span> Loading transaction data...
        </div>
        <div id="txContent" style="display: none;">
          <div class="data-label">Transaction Hash</div>
          <div class="data-value" id="txHash" style="font-size: 1.2rem; word-break: break-all;"></div>
          
          <div style="display: flex; justify-content: space-between; margin-top: 15px;">
            <div>
              <div class="data-label">From</div>
              <div class="data-secondary" id="txFrom"></div>
            </div>
            <div>
              <div class="data-label">To</div>
              <div class="data-secondary" id="txTo"></div>
            </div>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-top: 15px;">
            <div>
              <div class="data-label">Amount</div>
              <div class="data-secondary" id="txAmount"></div>
            </div>
            <div>
              <div class="data-label">Type</div>
              <div class="data-secondary">
                <span class="badge badge-primary" id="txType"></span>
              </div>
            </div>
            <div>
              <div class="data-label">Status</div>
              <div class="data-secondary">
                <span class="badge badge-success" id="txStatus"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-section">
      <h2>Role Allocations</h2>
      <div class="card">
        <div id="rolesLoading">
          <span class="loading"></span> Loading role allocation data...
        </div>
        <div id="rolesList" style="display: none;">
          <!-- Role items will be inserted here dynamically -->
        </div>
      </div>
    </div>

    <div class="actions">
      <a href="./swf-database.html" class="button">Database Dashboard</a>
      <a href="./minimal.html" class="button">Static Status Page</a>
    </div>
  </div>

  <script>
    // Base URL for API
    const API_BASE_URL = `http://${window.location.hostname}:5001/api`;
    
    // Helper function to truncate addresses
    function truncateAddress(address) {
      return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
    }
    
    // Helper function to format wei values to display format
    function formatWei(wei) {
      // Convert to ether (divide by 10^18)
      const ether = BigInt(wei) / BigInt(10 ** 18);
      return ether.toLocaleString();
    }
    
    // Helper function to format timestamp
    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString();
    }
    
    // Function to check API connection
    async function checkAPIConnection() {
      const statusElement = document.getElementById('apiStatus');
      
      try {
        const response = await fetch(`${API_BASE_URL}/health`);
        const data = await response.json();
        
        if (data.status === 'OK') {
          statusElement.className = 'api-status connected';
          statusElement.innerHTML = '<span class="status-indicator"></span>Connected';
          console.log('API connection successful');
          return true;
        } else {
          throw new Error('API status not OK');
        }
      } catch (error) {
        console.error('API connection error:', error);
        statusElement.className = 'api-status disconnected';
        statusElement.innerHTML = '<span class="status-indicator"></span>Disconnected';
        return false;
      }
    }
    
    // Function to load the latest transaction
    async function loadLatestTransaction() {
      const txLoading = document.getElementById('txLoading');
      const txContent = document.getElementById('txContent');
      
      try {
        const response = await fetch(`${API_BASE_URL}/transactions/address/0xCe36333A88c2EA01f28f63131fA7dfa80AD021F6`);
        const transactions = await response.json();
        
        if (transactions && transactions.length > 0) {
          const tx = transactions[0]; // Get the first (latest) transaction
          
          // Update the transaction details in the UI
          document.getElementById('txHash').textContent = tx.tx_hash;
          document.getElementById('txFrom').textContent = truncateAddress(tx.from_address);
          document.getElementById('txTo').textContent = truncateAddress(tx.to_address);
          document.getElementById('txAmount').textContent = `${formatWei(tx.amount)} SWF`;
          document.getElementById('txType').textContent = tx.transaction_type;
          document.getElementById('txStatus').textContent = tx.status;
          
          // Show the content and hide the loading indicator
          txLoading.style.display = 'none';
          txContent.style.display = 'block';
        } else {
          throw new Error('No transactions found');
        }
      } catch (error) {
        console.error('Error loading transaction:', error);
        txLoading.textContent = 'Error loading transaction data. Please try again later.';
      }
    }
    
    // Function to load role allocations
    async function loadRoleAllocations() {
      const rolesLoading = document.getElementById('rolesLoading');
      const rolesList = document.getElementById('rolesList');
      
      try {
        const response = await fetch(`${API_BASE_URL}/roles`);
        const roles = await response.json();
        
        if (roles && roles.length > 0) {
          // Process roles to remove duplicates (take the highest ID for each role name)
          const uniqueRoles = {};
          roles.forEach(role => {
            const key = role.role_name;
            if (!uniqueRoles[key] || uniqueRoles[key].id < role.id) {
              uniqueRoles[key] = role;
            }
          });
          
          // Build the UI elements
          rolesList.innerHTML = '';
          Object.values(uniqueRoles).forEach(role => {
            const roleItem = document.createElement('div');
            roleItem.className = 'role-item';
            roleItem.innerHTML = `
              <div>
                <strong>${role.role_name}</strong>
                <div class="data-secondary">${role.description || ''}</div>
              </div>
              <div>
                <div>${role.allocation_percentage}%</div>
                <div class="data-secondary" title="${role.wallet_address}">${truncateAddress(role.wallet_address)}</div>
              </div>
            `;
            rolesList.appendChild(roleItem);
          });
          
          // Show the content and hide the loading indicator
          rolesLoading.style.display = 'none';
          rolesList.style.display = 'block';
        } else {
          throw new Error('No role allocations found');
        }
      } catch (error) {
        console.error('Error loading roles:', error);
        rolesLoading.textContent = 'Error loading role allocation data. Please try again later.';
      }
    }
    
    // Function to load current APR from vault
    async function loadCurrentAPR() {
      try {
        const response = await fetch(`${API_BASE_URL}/vaults`);
        const vaults = await response.json();
        
        if (vaults && vaults.length > 0) {
          // Use the first vault's APR
          const apr = vaults[0].current_apr;
          document.getElementById('currentApr').textContent = `${apr}%`;
        }
      } catch (error) {
        console.error('Error loading vault APR:', error);
      }
    }
    
    // Initialize when the page loads
    document.addEventListener('DOMContentLoaded', async () => {
      // Check API connection
      const connected = await checkAPIConnection();
      
      if (connected) {
        // Load data
        loadLatestTransaction();
        loadRoleAllocations();
        loadCurrentAPR();
      } else {
        // Update UI to show disconnected state
        document.getElementById('txLoading').textContent = 'Cannot connect to API server. Please check server status.';
        document.getElementById('rolesLoading').textContent = 'Cannot connect to API server. Please check server status.';
      }
    });
  </script>
</body>
</html>